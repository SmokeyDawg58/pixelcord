// SVG Util
@use "sass:string";
@import "../../../src/icons/util";

@mixin replaceGuildShape($shape, $shape-hover) {
	.svg-2zuE5p > defs > path:not([d='M0 24C0 16.5449 0 12.8174 1.21793 9.87706C2.84183 5.95662 5.95662 2.84183 9.87706 1.21793C12.8174 0 16.5449 0 24 0C31.4551 0 35.1826 0 38.1229 1.21793C42.0434 2.84183 45.1582 5.95662 46.7821 9.87706C48 12.8174 48 16.5449 48 24C48 31.4551 48 35.1826 46.7821 38.1229C45.1582 42.0434 42.0434 45.1582 38.1229 46.7821C35.1826 48 31.4551 48 24 48C16.5449 48 12.8174 48 9.87706 46.7821C5.95662 45.1582 2.84183 42.0434 1.21793 38.1229C0 35.1826 0 31.4551 0 24Z']) {
		d: path($shape);
	}.svg-2zuE5p > defs > path[d='M0 24C0 16.5449 0 12.8174 1.21793 9.87706C2.84183 5.95662 5.95662 2.84183 9.87706 1.21793C12.8174 0 16.5449 0 24 0C31.4551 0 35.1826 0 38.1229 1.21793C42.0434 2.84183 45.1582 5.95662 46.7821 9.87706C48 12.8174 48 16.5449 48 24C48 31.4551 48 35.1826 46.7821 38.1229C45.1582 42.0434 42.0434 45.1582 38.1229 46.7821C35.1826 48 31.4551 48 24 48C16.5449 48 12.8174 48 9.87706 46.7821C5.95662 45.1582 2.84183 42.0434 1.21793 38.1229C0 35.1826 0 31.4551 0 24Z'] {
		d: path($shape-hover);
	}
	.svg-2zuE5p > foreignObject:first-child {
		-webkit-mask-image: var(--guild-shape-normal);
		-webkit-mask-size: contain;
		-webkit-mask-position: center;
		-webkit-mask-repeat: no-repeat;
		border-radius: 0;
	}
}

@function wrapperSVG($shape, $fill: 'black', $extra: '') {
	@return "<svg viewBox='0 0 48 48' xmlns='http://www.w3.org/2000/svg'><path fill='#{$fill}' d='#{$shape}'/>#{$extra}</svg>";
}
@function statusSVG($shape, $mask: '<rect></rect>') {
	@return "<svg viewBox='0 0 48 48' xmlns='http://www.w3.org/2000/svg'><defs><clipPath id='yeet'>#{$mask}</clipPath></defs><path fill='#fff' d='#{$shape}' clip-path='url(#yeet)'/></svg>";
}

@mixin maskImage($shape) {
	-webkit-mask-image: var(--avatar-shape);
	-webkit-mask-size: contain;
	-webkit-mask-position: center;
	-webkit-mask-repeat: no-repeat;
	border-radius: 0;
}

// Discord has multiple SVG masks for different image resolutions:
$status_round: (
		16: '<circle fill="black" cx="0.8125" cy="0.8125" r="0.3125"/>',
		24: '<circle fill="black" cx="0.8333333333333334" cy="0.8333333333333334" r="0.2916666666666667"/>',
		32: '<circle fill="black" cx="0.84375" cy="0.84375" r="0.25"/>',
		40: '<circle fill="black" cx="0.85" cy="0.85" r="0.25"/>',
		80: '<circle fill="black" cx="0.85" cy="0.85" r="0.175"/>',
		120: '<circle fill="black" cx="0.8333333333333334" cy="0.8333333333333334" r="0.16666666666666666"/>'
) !default;
$status_mobile: (
		16: '<rect fill="black" x="0.5" y="0.3125" width="0.625" height="0.8125" rx="0.1625" ry="0.1625"/>',
		24: '<rect fill="black" x="0.5416666666666666" y="0.375" width="0.5833333333333334" height="0.75" rx="0.15" ry="0.15"/>',
		32: '<rect fill="black" x="0.59375" y="0.4375" width="0.5" height="0.65625" rx="0.13125" ry="0.13125"/>',
		40: '<rect fill="black" x="0.6" y="0.45" width="0.5" height="0.65" rx="0.13" ry="0.13"/>',
		80: '<rect fill="black" x="0.675" y="0.575" width="0.35" height="0.45" rx="0.09" ry="0.09"/>',
		120: '<rect fill="black" x="0.6666666666666666" y="0.5666666666666667" width="0.3333333333333333" height="0.43333333333333335" rx="0.08666666666666667" ry="0.08666666666666667"/>'
) !default;
$status_typing: (
		16: '<rect fill="black" x="0.21875" y="0.5" width="1.1875" height="0.625" rx="0.3125" ry="0.3125"/>',
		24: '<rect fill="black" x="0.2916666666666667" y="0.5416666666666666" width="1.0833333333333333" height="0.5833333333333334" rx="0.2916666666666667" ry="0.2916666666666667"/>',
		32: '<rect fill="black" x="0.359375" y="0.59375" width="0.96875" height="0.5" rx="0.25" ry="0.25"/>',
		40: '<rect fill="black" x="0.375" y="0.6" width="0.95" height="0.5" rx="0.25" ry="0.25"/>',
		80: '<rect fill="black" x="0.525" y="0.675" width="0.65" height="0.35" rx="0.175" ry="0.175"/>',
		120: '<rect fill="black" x="0.5166666666666667" y="0.6666666666666666" width="0.6333333333333333" height="0.3333333333333333" rx="0.16666666666666666" ry="0.16666666666666666"/>'
) !default;

@mixin avatarStatusMask($shape, $size, $swap) {
	.avatarHint-k7pYop,
	.mask-1FEkla {
		$encodedSvg: var(--avatar-shape);

		& > foreignObject[mask="url(#svg-mask-avatar-status-round-#{$size})"] {
			$statusMask: #{svg-url("<svg viewBox='0 0 1 1' height='#{$size}' width='#{$size}' xmlns='http://www.w3.org/2000/svg'>#{map-get($status_round, $size)}</svg>")};
			-webkit-mask: $statusMask, $encodedSvg;
		}

		& > foreignObject[mask="url(#svg-mask-avatar-status-mobile-#{$size})"] {
			$statusMask: #{svg-url("<svg viewBox='0 0 1 1' height='#{$size}' width='#{$size}' xmlns='http://www.w3.org/2000/svg'>#{map-get($status_mobile, $size)}</svg>")};
			-webkit-mask: $statusMask, $encodedSvg;
		}

		& > foreignObject[mask="url(#svg-mask-avatar-status-typing-#{$size})"] {
			$statusMask: #{svg-url("<svg viewBox='0 0 1 1' height='#{$size}' width='#{$size}' xmlns='http://www.w3.org/2000/svg'>#{map-get($status_typing, $size)}</svg>")};
			-webkit-mask: $statusMask, $encodedSvg;
		}
	}
}

@mixin includeIconShapes($shape: '', $hoverShape: '', $swap: false) {

	@if $shape == '' {
		$shape: 'M24 4l-18 10v20l18 10 18-10v-20l-18-10z';
	}
	@if $hoverShape == '' {
		$hoverShape: $shape;
	}
	
	:root {
		--guild-shape-normal:  	#{svg-url(#{wrapperSVG($shape)})};
		--guild-shape-hover:  	#{svg-url(#{wrapperSVG($hoverShape)})};
		--avatar-shape:  		#{svg-url(#{wrapperSVG($shape)})};
	}

	@include replaceGuildShape($shape, $hoverShape);

	.avatar-3XmvJx,
	.guildIcon-2Tpnad.iconSizeSmol-qsFaRK,
	.replyAvatar-sHd2sU,
	.embedAuthorIcon-3pnkS4,
	// Mutuals => Guilds
	.iconSizeMedium-2vzSua.listAvatar-2bU5Uh,
	.avatar-2e8lTP:not(.avatar-2e8lTP[data-bsi-status]),
	.guildIcon-EvT-p6,
	.voiceSectionGuildImage-TctMOd,
	// Add border
	.avatarUploader-2UF9NL,
	// Cre-Arts' Friends Grid breaks without this
	#app-mount .peopleColumn-1wMU14 .avatar-2MSPKk::before {
		@include maskImage($hoverShape);
	}

	// VCs
	.avatar-3FKimL,
	.listDefault-2F-w65 .avatarContainer-3FF_Km {
		@include maskImage($hoverShape);
		box-shadow: none;
		
		// Speaking is broken
		&.avatarSpeaking-2pCGrZ {
			@include maskImage($hoverShape);
			-webkit-mask-size: 22px;
			
			position: relative;
			z-index: 2;
		}
	}
	.usernameSpeaking-3FKv6H::before {
		content: "";

		// 1px bigger
		margin: -1px 0 0 -1px;
		width: 26px;
		height: 26px;
		
		background: var(--accent);
		display: block;
		z-index: 1;
		position: absolute;
		@include maskImage($hoverShape);
		top: 3px;
		left: 8px;
	}
	.container-YkUktl .avatarStack-3vfSFa,
	.voiceUser-3nRK-K {
		& .avatar-b5OQ1N {
			z-index: 2;
		}
	}
	// really hacky way to check if user in current logged in panel is speaking or not
	.container-YkUktl .avatarStack-3vfSFa {
		// if we arent the first and last child (aka only child) we are therefore speaking
		.avatar-b5OQ1N:first-child:not(:last-child) {
			@include maskImage($hoverShape);
			-webkit-mask-size: 28px;
			-webkit-mask-position: center;
			width: 28px;
			height: 28px;
			margin: 2px;
		}
	}
	.avatarSpeaking-33RRJU {
		@include maskImage($hoverShape);
		background: var(--accent);
		box-shadow: none;

		// 1px bigger
		margin: -1px 0 0 -1px;
		width: 34px;
		height: 34px;

		position: absolute;
		z-index: 1;
	}
	.content-1Tgc42 {
		position: relative;
	}
	// VC collapsed speaking :kms:

	// Remove from wrappers
	.avatar-3QF_VA,
	.avatar-2Vndt_,
	.avatar-2OC07D,
	.avatar-3mTjvZ {
		&.wrapper-1VLyxH {
			border-radius: 0;
			// additional path at the end is to prevent clipping of the status
			-webkit-mask-image: var(--avatar-shape), #{svg-url("<svg viewBox='0 0 2 2' xmlns='http://www.w3.org/2000/svg'><path d='M0 1v1h2V1z'/></svg>")};
		}
	}

	.avatarContainerMasked-13fYnN,
	.folderIconWrapper-1_bOZe,
	.wrapperSimple-Js2rIO,
	.wrapper-1VLyxH {
		border-radius: 0;	
	}
	
	.avatarHint-2g3Mcd > foreignObject[mask="url(#svg-mask-avatar-status-round-80)"],
	.avatarContainerMasked-13fYnN > foreignObject[mask="url(#svg-mask-voice-user-summary-item)"],
	.mask-1FEkla > foreignObject[mask="url(#svg-mask-avatar-default)"] {
		-webkit-mask: var(--avatar-shape);
		mask: none;
	}

	@include avatarStatusMask($hoverShape, 16,  $swap);
	@include avatarStatusMask($hoverShape, 24,  $swap);
	@include avatarStatusMask($hoverShape, 32,  $swap);
	@include avatarStatusMask($hoverShape, 40,  $swap);
	@include avatarStatusMask($hoverShape, 80,  $swap);
	@include avatarStatusMask($hoverShape, 120, $swap);

	.avatarHint-k7pYop,
	.mask-1FEkla {
		
		& > foreignObject[mask|="url(#svg-mask-avatar-status-round"],
		& > foreignObject[mask|="url(#svg-mask-avatar-status-mobile"],
		& > foreignObject[mask|="url(#svg-mask-avatar-status-typing"] {
			-webkit-mask-size: contain;
			-webkit-mask-composite: destination-out;
			mask: none;
		}
	}
	
	// Padding in collapsed VCs
	.size16-2-tfaM .avatarContainerMasked-13fYnN,
	.size24-9rrwDS .avatarContainerMasked-13fYnN {
		margin-right: 4px;
	}
	
	// Party members (in now playing) have a unique mask :DDD
	.partyMember-YLjOa7 {
		mask: none;
		-webkit-mask: none;
	}

	// Fix for feature messages
	.avatar-2e8lTP::before {
		content: none;
	}
}
